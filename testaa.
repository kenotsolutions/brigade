const { events, Job } = require("brigadier")

events.on("exec", (e, project) => {

  var dockerBuild = new Job("docker-build")

  dockerBuild.image = "docker:dind"
  dockerBuild.serviceAccount = "brigade-installer";
  dockerBuild.privileged = true; // dind needs to run in privileged mode

  dockerBuild.env = {
    DOCKER_DRIVER: "overlay"
  }

  // Place these credentials in your project YAML and update it using helm 
  dockerBuild.env.DOCKER_USER = project.secrets.dockerLogin 
  dockerBuild.env.DOCKER_PASS = project.secrets.dockerPass

  dockerBuild.tasks = [
    "dockerd-entrypoint.sh &", // Start the docker daemon
    "sleep 20000", // Grant it enough time to be up and running
    "cd /src/", // Go to the project checkout dir
    "docker build -t kenotsolutions/nginx-brigade:latest .", // Replace with your own image tag
    "docker login -u $DOCKER_USER -p $DOCKER_PASS",
    "docker push kenotsolutions/nginx-brigade:latest" // Replace with your own image tag
  ]

  dockerBuild.run().then( () => {
    events.emit("build-done", e, project) // Fire the next event
  })
})
